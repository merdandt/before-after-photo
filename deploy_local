#!/bin/bash
set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuration
SERVICE_NAME="before-after-photo"
PORT=8080

echo -e "${BLUE}===================================${NC}"
echo -e "${BLUE}Local Docker Deployment${NC}"
echo -e "${BLUE}===================================${NC}"

# Load environment variables from .env.local if it exists
if [ -f .env.local ]; then
    echo -e "${YELLOW}Loading environment variables from .env.local...${NC}"
    export $(grep -v '^#' .env.local | xargs)
fi

# Stop and remove existing container if it exists
if docker ps -a --format '{{.Names}}' | grep -q "^${SERVICE_NAME}$"; then
    echo -e "${YELLOW}Stopping existing container...${NC}"
    docker stop ${SERVICE_NAME} || true
    docker rm ${SERVICE_NAME} || true
fi

# Build the Docker image
echo -e "${BLUE}Building Docker image...${NC}"
docker build -t ${SERVICE_NAME}:local .

# Run the container
echo -e "${BLUE}Starting container...${NC}"
docker run -d \
    --name ${SERVICE_NAME} \
    -p ${PORT}:8080 \
    -e PORT=8080 \
    -e GEMINI_API_KEY="${GEMINI_API_KEY:-PLACEHOLDER_API_KEY}" \
    ${SERVICE_NAME}:local

# Wait for container to be healthy
echo -e "${YELLOW}Waiting for service to be ready...${NC}"
sleep 3

# Check if service is running
if docker ps --format '{{.Names}}' | grep -q "^${SERVICE_NAME}$"; then
    echo -e "${GREEN}===================================${NC}"
    echo -e "${GREEN}✓ Service is running!${NC}"
    echo -e "${GREEN}===================================${NC}"
    echo -e "${GREEN}Local URL: http://localhost:${PORT}${NC}"
    echo -e "${GREEN}Health Check: http://localhost:${PORT}/health${NC}"
    echo ""
    echo -e "${YELLOW}Useful commands:${NC}"
    echo -e "  View logs:      docker logs -f ${SERVICE_NAME}"
    echo -e "  Stop service:   docker stop ${SERVICE_NAME}"
    echo -e "  Remove service: docker rm ${SERVICE_NAME}"
    echo ""

    # Test health endpoint
    echo -e "${BLUE}Testing health endpoint...${NC}"
    sleep 2
    if curl -s http://localhost:${PORT}/health > /dev/null 2>&1; then
        echo -e "${GREEN}✓ Health check passed!${NC}"
    else
        echo -e "${YELLOW}⚠ Health check not ready yet. Container may still be starting...${NC}"
    fi
else
    echo -e "${YELLOW}⚠ Container may have failed to start. Check logs with: docker logs ${SERVICE_NAME}${NC}"
    exit 1
fi
